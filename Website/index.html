<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>MPSTME | Attendance</title>
    <meta name="description" content="Check your latest attendance records here.">
    <meta name="keywords" content="MPSTME, NMIMS, SVKM, Attendance, Report">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="favicon.ico" rel="icon">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@500;700&display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@500;700&display=swap">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/style.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.4/dist/cal-heatmap.min.css" defer>
    <!-- Warms up Server -->
    <script>
      fetch('https://attendance-backend.spirax.me/v1/getAttendanceReport?ping=true', {
        method: 'POST'
      });
    </script>
  </head>
  <body>
    <div class="container-fluid position-relative d-flex p-0" style="min-height: 100vh; flex-direction: column;">
      <!-- Spinner Start -->
      <div id="spinner" class="show bg-dark position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <!-- Spinner End -->
      <!-- Content Start -->
      <div class="content open" style="flex: 1;">
        <!-- Navbar Start -->
        <nav class="navbar navbar-expand bg-secondary navbar-dark sticky-top px-4 py-0">
          <span class="navbar-brand mb-0 h1">MPSTME Attendance Report</span>
          <div class="navbar-nav align-items-center ms-auto">
            <a rel="noopener" href="https://github.com/ItsSpirax/MPSTME-Attendance-Report" class="nav-link" target="_blank">
              <i>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
                  <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8" />
                </svg>
              </i> FOSS Project </a>
          </div>
        </nav>
        <!-- Navbar End -->
        <!-- Sale & Revenue Start -->
        <div class="container-fluid pt-4 px-4" id="attendance-form-container">
          <div class="row justify-content-center">
            <div class="col-sm-12 col-xl-4">
              <div class="bg-secondary rounded h-100 p-4">
                <form id="attendance-form">
                  <div class="mb-3">
                    <label for="sapid" class="form-label">SAP ID</label>
                    <input type="text" class="form-control" id="sapid" required>
                  </div>
                  <div class="mb-3">
                    <label for="password" class="form-label">Portal Password</label>
                    <input type="password" class="form-control" id="password" required minlength="8">
                  </div>
                  <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="password-toggle">
                    <label class="form-check-label" for="password-toggle">Show Password</label>
                  </div>
                  <div class="mb-3">
                    <div class="cf-turnstile" data-sitekey="0x4AAAAAAAx-ANXhF-Birz5X"></div>
                    <input type="hidden" id="cf-turnstile-response" name="cf-turnstile-response">
                  </div>
                  <button type="submit" class="btn btn-primary" id="submit">Get Attendance</button>
                  <div id="error-message" class="text-danger mt-2" style="display: none;"></div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div class="container-fluid pt-4 px-4" id="attendance-report-container" style="display: none;">
          <div class="bg-secondary rounded h-100 p-4">
            <h6 class="mb-4">Attendance Report</h6>
            <table class="table table-bordered table-hover table-responsive" id="attendance-table"></table>
          </div>
        </div>
        <div class="container-fluid pt-4 px-4" id="line-chart-container" style="display: none;">
          <div class="bg-secondary rounded h-100 p-4">
            <h6 class="mb-4">Line Chart</h6>
            <canvas id="line-chart"></canvas>
          </div>
        </div>
        <div class="container-fluid pt-4 px-4" id="github-chart-container" style="display: none;">
          <div class="bg-secondary rounded h-100 p-4">
            <h6 class="mb-4">GitHub Chart</h6>
            <canvas id="github-chart"></canvas>
          </div>
        </div>
        <!-- Footer Start -->
        <footer class="bg-dark text-white text-center py-3" style="position: sticky; bottom: 0; width: 100%;"> &copy; <a rel="noopener" href="https://github.com/ItsSpirax">Adith</a>, All Right Reserved. </footer>
        <!-- Footer End -->
      </div>
      <!-- Content End -->
      <!-- Back to Top -->
      <a href="" class="btn btn-lg btn-primary btn-lg-square back-to-top">
        <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" fill="currentColor" class="bi bi-arrow-up" viewBox="0 0 16 16">
          <path fill-rule="evenodd" stroke="white" stroke-width="0.3" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5" />
        </svg>
      </a>
    </div>
    <!-- JavaScript Libraries -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.4/dist/cal-heatmap.min.js" defer></script>
    <script>
      const username = document.getElementById('sapid');
      const password = document.getElementById('password');
      const errorMessage = document.getElementById('error-message');
      const togglePassword = document.getElementById('password-toggle');
      const submitButton = document.getElementById('submit');
      const attendanceTable = document.getElementById('attendance-table');
      const colorPalette = ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)', 'rgba(201, 203, 207, 0.7)', 'rgba(255, 99, 71, 0.7)', 'rgba(0, 255, 127, 0.7)', 'rgba(255, 20, 147, 0.7)', 'rgba(0, 191, 255, 0.7)', 'rgba(75, 0, 130, 0.7)', 'rgba(173, 216, 230, 0.7)', 'rgba(240, 128, 128, 0.7)', 'rgba(124, 252, 0, 0.7)', 'rgba(255, 215, 0, 0.7)', 'rgba(255, 105, 180, 0.7)', 'rgba(135, 206, 235, 0.7)', 'rgba(255, 140, 0, 0.7)'];
      let SAPIDTimeoutId, passwordTimeoutId, lineChartInstance;
      const displayError = (element, condition) => {
        element.style.display = condition ? 'block' : 'none';
      };
      togglePassword.addEventListener('click', () => {
        password.type = password.type === 'password' ? 'text' : 'password';
        togglePassword.classList.toggle('show', password.type === 'text');
      });
      document.getElementById('attendance-form').addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          submitButton.click();
        }
      });
      submitButton.addEventListener('click', async (event) => {
        event.preventDefault();
        const isSAPIDValid = !isNaN(username.value);
        const isPasswordValid = password.value.length >= 8;
        if (!isSAPIDValid) {
          displayError(errorMessage, true);
          errorMessage.textContent = 'Please enter a valid SAP ID.';
          return;
        }
        if (!isPasswordValid) {
          displayError(errorMessage, true);
          errorMessage.textContent = 'Password must be at least 8 characters long.';
          return;
        }
        errorMessage.textContent = '';
        errorMessage.style.display = 'none';
        submitButton.disabled = true;
        submitButton.innerHTML = `Loading 
																	<div class="spinner-border spinner-border-sm" role="status"></div>`;
        try {
          const token = await new Promise((resolve, reject) => {
            turnstile.ready(() => {
              turnstile.render('.cf-turnstile', {
                callback: resolve,
                'error-callback': () => reject('Turnstile error. Please try again.'),
              });
            });
          });
          const response = await fetch('https://attendance-backend.spirax.me/v1/getAttendanceReport', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username: username.value,
              password: password.value,
              'cf-turnstile-response': token,
            })
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.error || 'Failed to fetch attendance.');
          renderAttendanceTable(data.data);
          renderLineChart(data.data.Attendance.LineGraph);
          document.getElementById('attendance-report-container').style.display = 'block';
          document.getElementById('line-chart-container').style.display = 'block';
          document.getElementById('github-chart-container').style.display = 'block';
        } catch (error) {
          errorMessage.textContent = error.message;
          errorMessage.style.display = 'block';
        } finally {
          submitButton.disabled = false;
          submitButton.innerHTML = 'Get Attendance';
        }
      });

      function renderAttendanceTable(data) {
        attendanceTable.innerHTML = '';
        const headerRow = attendanceTable.createTHead().insertRow();
        ['Subject', 'Present', 'Total', 'Percentage'].forEach(text => headerRow.insertCell().textContent = text);
        data.Attendance.Data.forEach(({
          Subject,
          Present,
          Total,
          Percentage
        }) => {
          const row = attendanceTable.insertRow();
          row.insertCell().textContent = Subject;
          row.insertCell().textContent = Present;
          row.insertCell().textContent = Total;
          row.insertCell().textContent = `${Percentage}%`;
          row.style.color = Percentage < 80 ? 'red' : Percentage === 100 ? '#32CD32' : 'white';
        });
      }

      function renderLineChart(attendanceData) {
        const allDatesArray = [...new Set(Object.keys(attendanceData).flatMap(subject => Object.keys(attendanceData[subject]).map(Number)))].sort((a, b) => a - b);
        const labels = allDatesArray.map(date => new Date(date));
        const datasets = Object.keys(attendanceData).map((subject, index) => ({
          label: subject,
          data: allDatesArray.map(date => attendanceData[subject][date] ?? null),
          backgroundColor: colorPalette[index % colorPalette.length],
          borderColor: colorPalette[index % colorPalette.length].replace(/0.7/, '1'),
          fill: false,
          tension: 0.4
        }));
        if (lineChartInstance) lineChartInstance.destroy();
        lineChartInstance = new Chart(document.getElementById('line-chart').getContext('2d'), {
          type: 'line',
          data: {
            labels,
            datasets
          },
          options: {
            responsive: true,
            spanGaps: true,
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'month',
                  displayFormats: {
                    month: 'MMM yyyy'
                  }
                }
              },
              y: {
                min: 0,
                max: 100,
                ticks: {
                  stepSize: 10,
                  callback: val => `${val}%`
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  title: ctx => ctx[0].label.slice(0, 12).replace(/,\s*$/, ""),
                  label: ctx => `${ctx.dataset.label || ''}: ${ctx.raw || 0}%`
                }
              }
            }
          }
        });
        lineChartInstance.data.datasets.forEach((_, idx) => {
          if (idx !== 0) lineChartInstance.data.datasets[idx].hidden = true;
        });
      }
      const spinner = () => setTimeout(() => document.getElementById('spinner')?.classList.remove('show'), 1);
      spinner();
      const debounce = (func, delay) => {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
        };
      };
      const handleScroll = debounce(() => {
        document.querySelector('.back-to-top').style.display = window.scrollY > 300 ? 'block' : 'none';
      }, 300);
      window.addEventListener('scroll', handleScroll);
      document.querySelector('.back-to-top').addEventListener('click', (e) => {
        e.preventDefault();
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    </script>
  </body>
</html>