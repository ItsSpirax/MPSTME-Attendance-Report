<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta Tags -->
    <meta charset="UTF-8">
    <title>MPSTME | Attendance</title>
    <meta name="description" content="Check your latest attendance records here.">
    <meta name="keywords" content="MPSTME, NMIMS, SVKM, Attendance, Report">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="favicon.ico" rel="icon">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@500;700&display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Roboto:wght@500;700&display=swap">
    <!-- Stylesheet -->
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Warms up Server -->
    <script>
      fetch('https://attendance-backend.spirax.me/v1/getAttendanceReport?ping=true', {
        method: 'POST'
      });
    </script>
  </head>
  <!-- Body Start -->
  <body>
    <div class="container-fluid position-relative d-flex p-0" style="min-height: 100vh; flex-direction: column;">
      <!-- Spinner Start -->
      <div id="spinner" class="show bg-dark position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
      <!-- Spinner End -->
      <!-- Content Start -->
      <div class="content" style="flex: 1;">
        <!-- Navbar Start -->
        <nav class="navbar navbar-expand bg-secondary navbar-dark sticky-top px-4 py-0 user-select-none">
          <span class="navbar-brand mb-0 h1">MPSTME Attendance Report</span>
          <div class="navbar-nav align-items-center ms-auto">
            <a rel="noopener" href="https://github.com/ItsSpirax/MPSTME-Attendance-Report" class="nav-link" target="_blank">
              <div class="logo-container p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16">
                  <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8" />
                </svg> FOSS Project
              </div>
            </a>
          </div>
        </nav>
        <!-- Navbar End -->
        <!-- Login Container Start -->
        <div class="container-fluid pt-4 px-4">
          <div class="row justify-content-center">
            <div class="col-12 col-md-9 col-lg-8 col-xl-4">
              <div class="bg-secondary rounded h-100 p-4">
                <form id="attendance-form">
                  <div class="mb-3">
                    <label for="sapid" class="form-label">SAP ID</label>
                    <input type="text" class="form-control" id="sapid" required>
                  </div>
                  <div class="mb-3">
                    <label for="password" class="form-label">Portal Password</label>
                    <input type="password" class="form-control" id="password" required minlength="8">
                  </div>
                  <div class="mb-3 form-check user-select-none">
                    <input type="checkbox" class="form-check-input" id="password-toggle">
                    <label class="form-check-label" for="password-toggle">Show Password</label>
                  </div>
                  <div class="mb-3 d-flex justify-content-center">
                    <div class="cf-turnstile"></div>
                  </div>
                  <div class="d-flex justify-content-center">
                    <button type="submit" class="btn btn-primary" id="submit">Get Attendance</button>
                  </div>
                  <div class="d-flex justify-content-center mt-2">
                    <div id="error-message" class="text-danger mt-2" style="display: none;"></div>
                    <div id="loading-message" class="mt-2" style="display: none;">Please wait, this might take up to 30 seconds...</div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!-- Login Container End -->
        <!-- Attendance Report Container Start -->
        <div class="pt-2 pb-5" id="attendance-report-container" style="display: none;">
          <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-xl-8">
              <div class="container-fluid pt-4">
                <div class="bg-secondary rounded h-100 p-4" style="overflow-x: auto;">
                  <h6 class="mb-4">Attendance Report</h6>
                  <table class="table table-bordered table-hover" id="attendance-table"></table>
                </div>
              </div>
              <div class="container-fluid pt-4">
                <div class="bg-secondary rounded h-100 p-4" style="overflow: auto;">
                  <h6 class="mb-4">Line Chart</h6>
                  <canvas id="line-chart" style="max-width: 100%;"></canvas>
                </div>
              </div>
              <div class="container-fluid pt-4">
                <div class="bg-secondary rounded h-100 p-4" style="overflow: auto;">
                  <h6 class="mb-4">GitHub Graph</h6>
                  <div id="github-graph" style="max-width: 100%; overflow: auto;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Attendance Report Container End -->
        <!-- Footer Start -->
        <footer class="bg-dark text-center py-3" style="position: sticky; bottom: 0; width: 100%;"> &copy; <a rel="noopener" href="https://github.com/ItsSpirax">Adith</a>, All Rights Reserved. </footer>
        <!-- Footer End -->
      </div>
      <!-- Content End -->
      <!-- Back to Top -->
      <a href="#top" class="btn btn-lg btn-primary btn-lg-square back-to-top" aria-label="Back to Top">
        <svg xmlns="http://www.w3.org/2000/svg" width="21" height="21" fill="currentColor" class="bi bi-arrow-up" viewBox="0 0 16 16">
          <path fill-rule="evenodd" stroke="white" stroke-width="0.3" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5" />
        </svg>
      </a>
    </div>
    <!-- JavaScript Libraries -->
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit" data-cfasync="false"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/cal-heatmap@4.2.4/dist/cal-heatmap.min.js" defer></script>
    <script>
      const colorPalette = ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)', 'rgba(201, 203, 207, 0.7)', 'rgba(255, 99, 71, 0.7)', 'rgba(0, 255, 127, 0.7)', 'rgba(255, 20, 147, 0.7)', 'rgba(0, 191, 255, 0.7)', 'rgba(75, 0, 130, 0.7)', 'rgba(173, 216, 230, 0.7)', 'rgba(240, 128, 128, 0.7)', 'rgba(124, 252, 0, 0.7)', 'rgba(255, 215, 0, 0.7)', 'rgba(255, 105, 180, 0.7)', 'rgba(135, 206, 235, 0.7)', 'rgba(255, 140, 0, 0.7)'];
      let SAPIDTimeoutId, passwordTimeoutId, lineChartInstance, widgetID;
      // Spinner
      setTimeout(() => document.getElementById('spinner')?.classList.remove('show'), 1);

      // Captcha Render
      widgetID = turnstile.ready(function() {
        turnstile.render(".cf-turnstile", {
          sitekey: "0x4AAAAAAAx-ANXhF-Birz5X",
          theme: "dark",
          "expired-callback": captchaExpired,
        });
      });

      // Captcha Expired Callback
      function captchaExpired() {
        turnstile.reset(widgetID);
      }

      // Password Toggle
      const togglePassword = document.getElementById('password-toggle');
      togglePassword.addEventListener('click', () => {
        password.type = password.type === 'password' ? 'text' : 'password';
        togglePassword.classList.toggle('show', password.type === 'text');
      });

      // Submit Button
      const submitButton = document.getElementById('submit');
      document.getElementById('attendance-form').addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          submitButton.click();
        }
      });

      submitButton.addEventListener('click', async (event) => {
        event.preventDefault();
        const username = document.getElementById('sapid');
        const password = document.getElementById('password');
        const errorMessage = document.getElementById('error-message');
        const loadingMessage = document.getElementById('loading-message');

        if (isNaN(username.value) || username.value.length <= 4) {
          errorMessage.textContent = 'Please enter a valid SAP ID.';
          errorMessage.style.display = 'block';
          return;
        }
        if (!(password.value.length >= 8)) {
          errorMessage.textContent = 'Password must be at least 8 characters long.';
          errorMessage.style.display = 'block';
          return;
        }
        if (!turnstile.getResponse(widgetID) || turnstile.isExpired(widgetID)) {
          errorMessage.textContent = 'Please complete the captcha.';
          errorMessage.style.display = 'block';
          return;
        }

        errorMessage.textContent = '';
        errorMessage.style.display = 'none';
        submitButton.disabled = true;
        submitButton.innerHTML = `Generating Report&nbsp;&nbsp;
															<div class="spinner-border spinner-border-sm" role="status"></div>`;
        loadingMessage.style.display = 'block';
        try {
          const response = await fetch('https://attendance-backend.spirax.me/v1/getAttendanceReport', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              username: username.value,
              password: password.value,
              captcha: turnstile.getResponse(),
            })
          });
          const data = await response.json();
          if (!response.ok) throw new Error(data.error || 'We couldn\'t retrieve your attendance information at this time.');
          renderAttendanceTable(data.data);
          renderLineChart(data.data.Attendance.LineGraph);
          renderGithubChart(data.data.Attendance.GithubGraph);
          document.getElementById('attendance-report-container').style.display = 'block';
        } catch (error) {
          errorMessage.textContent = error.message;
          errorMessage.style.display = 'block';
        } finally {
          submitButton.disabled = false;
          submitButton.innerHTML = 'Get Attendance';
          loadingMessage.style.display = 'none';
          turnstile.reset(widgetID);
        }
      });

      // Attendance Report
      function renderAttendanceTable(data) {
        const attendanceTable = document.getElementById('attendance-table');
        attendanceTable.innerHTML = '';
        const headerRow = attendanceTable.createTHead().insertRow();
        ['Subject', 'Present', 'Total', 'Percentage'].forEach(text => headerRow.insertCell().textContent = text);
        data.Attendance.Data.forEach(({
          Subject,
          Present,
          Total,
          Percentage
        }) => {
          const row = attendanceTable.insertRow();
          row.insertCell().textContent = Subject;
          row.insertCell().textContent = Present;
          row.insertCell().textContent = Total;
          row.insertCell().textContent = `${Percentage}%`;
          row.style.color = Percentage < 80 ? '#de0a26' : Percentage === 100 ? '#32cd32' : '#ebe8e8';
        });
      }

      // Line Chart
      function renderLineChart(attendanceData) {
        const allDatesArray = [...new Set(Object.keys(attendanceData).flatMap(subject => Object.keys(attendanceData[subject]).map(Number)))].sort((a, b) => a - b);
        const labels = allDatesArray.map(date => new Date(date));
        const datasets = Object.keys(attendanceData).map((subject, index) => ({
          label: subject,
          data: allDatesArray.map(date => attendanceData[subject][date] ?? null),
          backgroundColor: colorPalette[index % colorPalette.length],
          borderColor: colorPalette[index % colorPalette.length].replace(/0.7/, '1'),
          fill: false,
          tension: 0.4
        }));
        if (lineChartInstance) lineChartInstance.destroy();
        lineChartInstance = new Chart(document.getElementById('line-chart').getContext('2d'), {
          type: 'line',
          data: {
            labels,
            datasets
          },
          options: {
            responsive: true,
            spanGaps: true,
            scales: {
              x: {
                type: 'time',
                time: {
                  unit: 'month',
                  displayFormats: {
                    month: 'MMM yyyy'
                  }
                }
              },
              y: {
                min: 0,
                max: 100,
                ticks: {
                  stepSize: 10,
                  callback: val => `${val}%`
                }
              }
            },
            plugins: {
              tooltip: {
                callbacks: {
                  title: ctx => ctx[0].label.slice(0, 12).replace(/,\s*$/, ""),
                  label: ctx => `${ctx.dataset.label || ''}: ${ctx.raw || 0}%`
                }
              },
              annotation: {
                annotations: [{
                  type: 'line',
                  mode: 'horizontal',
                  scaleID: 'y',
                  value: 80,
                  borderColor: 'white',
                  borderWidth: 1,
                  borderDash: [5, 5]
                }]
              }
            }
          }
        });
        lineChartInstance.data.datasets.forEach((_, idx) => {
          if (idx !== 0) lineChartInstance.data.datasets[idx].hidden = true;
        });
        setTimeout(() => lineChartInstance.update(), 1000);
      }

      // GitHub Graph
      function renderGithubChart(data) {
        const cal = new CalHeatmap();
        cal.paint({
          itemSelector: '#github-graph',
          domain: 'month',
          subDomain: 'day',
          data: data,
          start: new Date(new Date().getFullYear(), 0),
          range: 12,
          cellSize: 20,
          cellPadding: 5,
          domainGutter: 10,
          domainMargin: 10,
          legend: [0, 20, 40, 60, 80, 100],
          legendColors: {
            min: '#FF0000',
            max: '#32CD32',
            empty: '#FFFFFF'
          },
          displayLegend: true,
          legendVerticalPosition: 'center',
          legendHorizontalPosition: 'right',
          legendOrientation: 'vertical',
          legendCellSize: 15,
          tooltip: true,
        });
      }
      
      // Debounce Back to Top
      const debounce = (func, delay) => {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), delay);
        };
      };

      const handleScroll = debounce(() => {
        document.querySelector('.back-to-top').style.display = window.scrollY > 300 ? 'block' : 'none';
      }, 300);
      window.addEventListener('scroll', handleScroll);
      document.querySelector('.back-to-top').addEventListener('click', (e) => {
        e.preventDefault();
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    </script>
  </body>
</html>